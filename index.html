<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Start Page</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Rock Salt:wght@400&display=swap" rel="stylesheet">
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    connect-src 'self' https://api.open-meteo.com;
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: https://www.google.com;
">
</head>
<body>

    <div class="container">
    
        <!--  Clock & Weather Section -->
        <div class="datetime-container">
            <div class="time" id="clock">00:00</div>
            <div class="date" id="date">Loading Date...</div>
            <div class="weather" id="weather">Loading Weather...</div>
        </div>
        
        <h1 id="greeting">STAY FOCUSED!  </h1>

        <form action="https://www.google.com/search" method="GET" class="search-box">
            <label for="searchInput">
                <input type="text" id="searchInput" name="q" placeholder="Let's find it..." autocomplete="off" autofocus>
            </label>
        </form>

        <!--  The Slider Navigation -->
        <nav class="shortcut-slider" id="slider">
        <!-- Dynamic items will appear here -->
        
            <!-- The 'Add' Button is hardcoded at the end -->
            <div class="shortcut-item add-btn" id="btnAddShortcut">
                <div class="icon-circle">+</div>
                <span>Add</span>
            </div>
            <!-- End of Addbutton section -->
        </nav>
        <!-- End of The Slider Navigation section -->

        
    </div>

    <!--  The Modal (Hidden Form) -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h4>Add New Shortcut</h4>
            <input type="text" id="inputLabel" placeholder="Name (e.g. Google)">
            <input type="url" id="inputUrl" placeholder="URL (e.g. https://google.com)">
             <!-- Additions start here -->
            <label for="iconUpload">Custom Icon Upload (Optional):</label>
            <input type="file" id="iconUpload" accept="image/*">
            <small>If no file is chosen, we'll try to find the website's favicon.</small>
  <!-- Additions end here -->
            <div class="modal-buttons">
                <button class="cancel-btn" id="btnCloseModal">Cancel</button>
                <button class="save-btn" id="btnSaveShortcut">Save</button>
            </div>
        </div>
    </div>
    <!--  End of Modal -->
    
    
     <!--  Settings page section -->
    <div class="settings-btn" id="btnOpenSettings">
        ‚öôÔ∏è
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h4>System Settings</h4>
        
        
            <label>Weather Location</label>
            <label>Latitude:</label>
            <input type="text" id="settingLat" placeholder="e.g. 39.7953">
        
            <label>Longitude:</label>
            <input type="text" id="settingLon" placeholder="e.g. -93.5524">
        
            <small style="display:block; margin-bottom:15px; color:#888;">
            Tip: Google "Coordinates of [City Name]" to find these numbers.
            </small>

            <div class="modal-buttons">
                <button class="cancel-btn" id="btnCloseSettings">Cancel</button>
                <button class="save-btn" id="btnSaveSettings">Save Configuration</button>
            </div>
        </div>
    </div>
    
    <!--  JavaScript Logic -->
    <script>
        // Load saved shortcuts on page load
        document.addEventListener('DOMContentLoaded', loadShortcuts);

    // Google's free API service to fetch favicons
    const FAVICON_API = 'https://www.google.com/s2/favicons?domain=';

    function loadShortcuts() {
        const shortcuts = JSON.parse(localStorage.getItem('myShortcuts')) || [];
        const slider = document.getElementById('slider');
        const addButton = document.querySelector('.add-btn');

        shortcuts.forEach(shortcut => {
            // We now pass the icon data/URL to the creation function
            createShortcutElement(shortcut.label, shortcut.url, shortcut.icon, slider, addButton);
        });
    }

    function saveShortcut() {
        const label = document.getElementById('inputLabel').value;
        let url = document.getElementById('inputUrl').value;
        const iconFile = document.getElementById('iconUpload').files[0];

        if (!label || !url) return alert("Please fill in both name and URL");
        if (!url.startsWith('http')) url = 'https://' + url;

        // Use FileReader to convert uploaded image to a Data URL string
        if (iconFile) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64Icon = e.target.result;
                finalizeShortcutSave(label, url, base64Icon);
            };
            reader.readAsDataURL(iconFile); // Read the file as a Base64 URL
        } else {
            // If no file uploaded, try to grab the default favicon
            const domain = new URL(url).hostname;
            // We use Google's API to reliably fetch the favicon URL
            const faviconUrl = `${FAVICON_API}${encodeURIComponent(domain)}&sz=64`;
            finalizeShortcutSave(label, url, faviconUrl);
        }
    }

    function finalizeShortcutSave(label, url, iconData) {
        // 1. Save to Local Storage
        const shortcuts = JSON.parse(localStorage.getItem('myShortcuts')) || [];
        shortcuts.push({
            label,
            url,
            icon: iconData
        }); // Save the icon data/URL
        localStorage.setItem('myShortcuts', JSON.stringify(shortcuts));

        // 2. Add to DOM
        const slider = document.getElementById('slider');
        const addButton = document.querySelector('.add-btn');
        createShortcutElement(label, url, iconData, slider, addButton);

        // 3. Cleanup
        closeModal();
        document.getElementById('inputLabel').value = '';
        document.getElementById('inputUrl').value = '';
        document.getElementById('iconUpload').value = ''; // Clear file input
    }


    function createShortcutElement(label, url, iconData, container, insertBeforeNode) {
        const a = document.createElement('a');
        a.href = url;
        a.className = 'shortcut-item';

        let iconContent;
        if (iconData.startsWith('data:image') || iconData.startsWith('http')) {
            // If it's a Base64 string or URL, use an <img> tag
            iconContent = `<img src="${iconData}" alt="${label} icon">`;
        } else {
            // Fallback to the first letter if somehow icon data is missing/invalid
            iconContent = `<span>${label.charAt(0).toUpperCase()}</span>`;
        }

        a.innerHTML = `
                <div class="icon-circle">
                ${iconContent} 
                </div>
                <span>${label}</span>
            `;

        container.insertBefore(a, insertBeforeNode);
    }

    // Modal Controls (No changes needed here)
    function openModal() {
        document.getElementById('addModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('addModal').style.display = 'none';
    }

    // --- CLOCK & WEATHER CODE STARTS HERE ---
    // --- SMART SYSTEM SETTINGS CODE ---

    // Default: Chillicothe, MO
    const DEFAULT_LAT = 39.7953;
    const DEFAULT_LON = -93.5524;

    // Variables to hold current state
    let currentLat = localStorage.getItem('userLat') || DEFAULT_LAT;
    let currentLon = localStorage.getItem('userLon') || DEFAULT_LON;
    let currentTimeZone = localStorage.getItem('userTimeZone') || 'America/Chicago';

    // 1. THE CLOCK (Now uses TimeZone!)
    function updateClock() {
        const now = new Date();

        // We pass the 'timeZone' option to force the clock to match the location
        const timeString = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            timeZone: currentTimeZone
        });

        const dateString = now.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            timeZone: currentTimeZone
        });

        document.getElementById('clock').textContent = timeString;
        document.getElementById('date').textContent = dateString;
    }

    // 2. THE WEATHER (Updates TimeZone too!)
    async function getWeather() {
        try {
            // We ask for the timezone explicitly in the API call
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current_weather=true&temperature_unit=fahrenheit&timezone=auto`;

            const response = await fetch(url);
            const data = await response.json();

            // SAVE THE DETECTED TIMEZONE
            if (data.timezone) {
                currentTimeZone = data.timezone;
                localStorage.setItem('userTimeZone', data.timezone);
            }

            const temp = Math.round(data.current_weather.temperature);
            const code = data.current_weather.weathercode;

            // Icon Logic
            let icon = "‚òÄÔ∏è";
            if (code > 0 && code <= 3) icon = "‚òÅÔ∏è";
            if (code >= 45 && code <= 48) icon = "üå´Ô∏è";
            if (code >= 51 && code <= 67) icon = "üåßÔ∏è";
            if (code >= 71 && code <= 86) icon = "‚ùÑÔ∏è";
            if (code >= 95) icon = "‚ö°";

            document.getElementById('weather').textContent = `Current Weather \u00A0\u00A0\u00A0 ${icon} ${temp}¬∞F`;

            // Force clock update immediately so it doesn't wait 1 second to change timezones
            updateClock();

        } catch (error) {
            console.error("System Malfunction:", error);
            document.getElementById('weather').textContent = "Signal Lost";
        }
    }

    // 3. SETTINGS MENU LOGIC
    function openSettings() {
        // Pre-fill the inputs with current values
        document.getElementById('settingLat').value = currentLat;
        document.getElementById('settingLon').value = currentLon;
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    function saveSettings() {
        const newLat = document.getElementById('settingLat').value;
        const newLon = document.getElementById('settingLon').value;

        if (newLat && newLon) {
            // Update Variables
            currentLat = newLat;
            currentLon = newLon;

            // Save to Storage
            localStorage.setItem('userLat', newLat);
            localStorage.setItem('userLon', newLon);

            // Refresh Data
            getWeather(); // This will also update the timezone!
            closeSettings();
        } else {
            alert("Need valid coordinates, boss.");
        }
    }

    // Initialize System
    // 1. Start the intervals
    setInterval(updateClock, 1000);       // Schedule clock ticks
    setInterval(getWeather, 600000);      // Schedule weather updates (10 mins)

    // 2. Run them immediately so we don't wait for the first interval
    updateClock();
    getWeather();


    // --- EVENT LISTENERS (The "Safe" Way to Click) ---

    // 1. Settings Menu
    document.getElementById('btnOpenSettings').addEventListener('click', openSettings);
    document.getElementById('btnCloseSettings').addEventListener('click', closeSettings);
    document.getElementById('btnSaveSettings').addEventListener('click', saveSettings);

    // 2. Add Shortcut Menu
    // Note: Since .add-btn is inside the slider, we use a slightly different selector to be safe
    document.querySelector('.add-btn').addEventListener('click', openModal);

    // 3. Shortcut Modal Buttons
    // We need to find these buttons specifically inside the modal
    const addModal = document.getElementById('addModal');
    addModal.querySelector('.cancel-btn').addEventListener('click', closeModal);
    addModal.querySelector('.save-btn').addEventListener('click', saveShortcut);

    // --- END EVENT LISTENERS ---

    </script>     
    <!--End of JavaScript Logic -->
     
</body>
</html>
